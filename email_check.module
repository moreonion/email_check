<?php
/**
 * @file
 */

/**
 * Implements hook_mail_alter().
 *
 * Mails with the 'X-Mail-Domain' header set won't be altered.
 *
 * The Return-Path will be set either way.
 *
 * For mails where all addresses in the "From" field are using the
 * site mail domain, the "From" field won't be changed. If the
 * "ReplyTo" field isn't set, the site "ReplyTo" address will be
 * set in the "ReplyTo" field.
 *
 * Mails where the domain of the address in the "From" field
 * doesn't match the site mail domain will be changed: the
 * "From" address will be changed into a "ReplyTo" address
 * and the site mail address will be set as new "From" address.
 *
 * @param $message
 */
function email_check_mail_alter(&$message) {
  // if X-Mail-Domain is set -> let the mail server do the
  // "From" address mangling
  if (empty($message['headers']['X-Mail-Domain'])) {
    $site_mail_domain  = variable_get('site_mail_domain', NULL);
    $site_mail_address = variable_get('site_mail', NULL);
    $site_reply_to = variable_get('site_replyto_mail', variable_get('site_mail'));
    $site_return_path = variable_get('site_mail_return_path', variable_get('site_mail'));

    $site_mail_domain  = empty($site_mail_domain) ? 'campaignion.org' : $site_mail_domain;
    $site_mail_address = empty($site_mail_address) ? 'info@campaignion.org' : $site_mail_address;

    // make shure site_mail and site_mail_domain are consistend
    if (strpos($site_mail_address, '@' . $site_mail_domain) === FALSE) {
      $site_mail_address = 'info@' . $site_mail_domain;
    }

    //theoretically there could be more than 1 From: address
    $message_from_addresses = [];
    $pattern = '/(["][^"]+["])?[[:blank:]]*[<]?[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}\b[>]?/i';
    preg_match_all($pattern, $message['from'], $message_from_addresses);
    $message_from_addresses = array_shift($message_from_addresses); 
    $reply_to = !empty($message['headers']['Reply-To']) ? $message['headers']['Reply-To'] : '';
    foreach($message_from_addresses as $index => $address) {
      // if domain from "From" address is not the site mail domain
      // put this address in the ReplyTo field and replace the "From"
      // address with default site mail address
      if (strpos($address, '@' . $site_mail_domain) === FALSE) {
        $message_from_addresses[$index] = $site_mail_address;
        if (!$reply_to) {
          $reply_to = $address;
        }
      }
    }
    $message_from_addresses = array_unique($message_from_addresses);
    $message['from'] = $message['headers']['From'] = implode(',', $message_from_addresses);
    // only set reply-to to the site reply-to if we need to
    // ie. when the header from address IS the site_mail address and a site replyto is set
    // (the combination of site_mail and site_replyto_mail means: we want to subsitute;
    // the combination of any other mail within the mail_domain means: do not
    // set another reply to address)
    //
    // no need to check the domain of the reply to address, everything is allowed here
    //
    // TODO what to do is there are more than one from addresses?
    if (!$reply_to && $site_reply_to && strpos($message['from'], $site_mail_address) !== FALSE) {
      $reply_to = $site_reply_to;
    }
    if ($reply_to) {
      $message['headers']['Reply-To'] = $reply_to;
    }
  }

  // the Drupal default is to use the messages 'From' address
  // we want to be able to specify a specific bounce address
  // this header will be extracted by the mail engine and used for the `-f`
  // parameter of the `sendmail_path` command
  if (empty($message['headers']['Return-Path']) || strpos($message['headers']['Return-Path'], '@' . $site_mail_domain) === FALSE) {
    // set a default Return-Path if none is set or it is invalid
    $message['headers']['Return-Path'] = $site_return_path;
  }
  if (strpos($message['headers']['Return-Path'], '@' . $site_mail_domain) === FALSE) {
    // if the Return-Path is still invalid --> delete it
    unset($message['headers']['Return-Path']);
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 * Implements hook_form_system_site_information_settings_alter().
 *
 * Add a system settings entry to configure an email ReplyTo value
 */
function email_check_form_system_site_information_settings_alter(&$form, &$form_state) {
  form_load_include($form_state, 'php', 'email_check', 'email_check.admin');
  _email_check_system_site_information_settings_alter($form, $form_state);
}
